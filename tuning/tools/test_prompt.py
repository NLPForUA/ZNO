import unittest
from unittest.mock import patch

from transformers import AutoTokenizer

from tools.prompt import apply_template, format_prompt

class TestFormatPrompt(unittest.TestCase):

    def test_format_prompt_cot_with_answers(self):
        """
        Test the case when:
          - answer options are provided,
          - chain-of-thought (cot) is enabled,
          - chat_like is False.
        In this branch, the function uses get_prompt(), restores detailed explanation,
        clears only_letters, and formats the options and thoughts using the comment.
        """
        row = {
            "question": "Однаковий звук позначають букви, виділені в окремих словах речення",
            "answers": [
                {"answer": "А", "text": "Відповідаючи (виділено д - 8-й символ) їм, не забудьте (виділено д - 5-й символ) подякувати (виділено д - 3-й символ)."},
                {"answer": "Б", "text": "Лікувальні можливості (виділено ж - 3-й символ) живокосту (виділено ж - 1-й символ) безмежні (виділено ж - 6-й символ)."},
                {"answer": "В", "text": "Заспівала (виділено с - 3-й символ) сопілочка (виділено с - 1-й символ) осьдечки (виділено с - 2-й символ) за вікном."},
                {"answer": "Г", "text": "Ці квитки (виділено к - 1-й символ) можна обміняти в касі (виділено к - 1-й символ) вокзалу (виділено к - 3-й символ). "}
            ],
            "comment": (
                "Коментар"
                "\nТЕМА: Фонетика. Зміни звуків."
                "\nЦе завдання перевіряє ваші знання про зміни звуків у потоці мовлення. Цьогоріч у завданні запропоновано речення, в окремих словах яких підкреслено певні звуки."
                "\nРозглянемо рядок з такими слова: заспівала, сопілка, осьдечки."
                "\nПідкреслені букви в цих словах позначають різні звуки: у слові сопілка це [с], а в словах заспівала (далі в слові після [с′] пом’якшений губний [п’]) та осьдечки (після [с′] далі м’який знак) – [с′]."
                "\nУ рядку зі словами відповідаючи, забудьте, подякувати підкреслені літери теж позначають різні звуки: у слові відповідаючи це звук [д]; у словах забудьте та подякувати це звук [д′], адже далі відповідно бачимо м’який знак та букву я."
                "\nУ словах квитки та касі вимовляємо звук [к], а в слові вокзалу це звук [ґ], адже глухий звук [к] перед дзвінким вимовляємо як [ґ]."
                "\nУ словах можливості, живокосту, безмежні всі підкреслені літери позначають звук [ж]"
                "\nВідповідь – Г. "
            ),
            "correct_answer": ["Г"]  # not used in the cot branch
        }
        result = format_prompt(row, cot=True, chat_like=False)
        expected = (
            'Дайте розгорнуту відповідь на завдання, починаючи з ключового слова "Відповідь:" та використовуючи лише наведені нижче варіанти.'
            '\n\nЗавдання: Однаковий звук позначають букви, виділені в окремих словах речення'
            '\n\nВаріанти відповіді:\nА - Відповідаючи (виділено д - 8-й символ) їм, не забудьте (виділено д - 5-й символ) подякувати (виділено д - 3-й символ).'
            '\nБ - Лікувальні можливості (виділено ж - 3-й символ) живокосту (виділено ж - 1-й символ) безмежні (виділено ж - 6-й символ).'
            '\nВ - Заспівала (виділено с - 3-й символ) сопілочка (виділено с - 1-й символ) осьдечки (виділено с - 2-й символ) за вікном.'
            '\nГ - Ці квитки (виділено к - 1-й символ) можна обміняти в касі (виділено к - 1-й символ) вокзалу (виділено к - 3-й символ). '
            '\n\nВідповідь:'
            "\nТЕМА: Фонетика. Зміни звуків."
            "\nЦе завдання перевіряє ваші знання про зміни звуків у потоці мовлення. Цьогоріч у завданні запропоновано речення, в окремих словах яких підкреслено певні звуки."
            "\nРозглянемо рядок з такими слова: заспівала, сопілка, осьдечки."
            "\nПідкреслені букви в цих словах позначають різні звуки: у слові сопілка це [с], а в словах заспівала (далі в слові після [с′] пом’якшений губний [п’]) та осьдечки (після [с′] далі м’який знак) – [с′]."
            "\nУ рядку зі словами відповідаючи, забудьте, подякувати підкреслені літери теж позначають різні звуки: у слові відповідаючи це звук [д]; у словах забудьте та подякувати це звук [д′], адже далі відповідно бачимо м’який знак та букву я."
            "\nУ словах квитки та касі вимовляємо звук [к], а в слові вокзалу це звук [ґ], адже глухий звук [к] перед дзвінким вимовляємо як [ґ]."
            "\nУ словах можливості, живокосту, безмежні всі підкреслені літери позначають звук [ж]"
            "\nВідповідь – Г."
        )
        self.assertEqual(result, expected)


    def test_format_prompt_cot_with_answers_chat_like(self):
        """
        Test the case when:
          - answer options are provided,
          - chain-of-thought (cot) is enabled,
          - chat_like is True.
        In this branch, the function uses get_prompt(), restores detailed explanation,
        clears only_letters, and formats the options and thoughts using the comment.
        """
        row = {
            "question": "Однаковий звук позначають букви, виділені в окремих словах речення",
            "answers": [
                {"answer": "А", "text": "Відповідаючи (виділено д - 8-й символ) їм, не забудьте (виділено д - 5-й символ) подякувати (виділено д - 3-й символ)."},
                {"answer": "Б", "text": "Лікувальні можливості (виділено ж - 3-й символ) живокосту (виділено ж - 1-й символ) безмежні (виділено ж - 6-й символ)."},
                {"answer": "В", "text": "Заспівала (виділено с - 3-й символ) сопілочка (виділено с - 1-й символ) осьдечки (виділено с - 2-й символ) за вікном."},
                {"answer": "Г", "text": "Ці квитки (виділено к - 1-й символ) можна обміняти в касі (виділено к - 1-й символ) вокзалу (виділено к - 3-й символ). "}
            ],
            "comment": (
                "Коментар"
                "\nТЕМА: Фонетика. Зміни звуків."
                "\nЦе завдання перевіряє ваші знання про зміни звуків у потоці мовлення. Цьогоріч у завданні запропоновано речення, в окремих словах яких підкреслено певні звуки."
                "\nРозглянемо рядок з такими слова: заспівала, сопілка, осьдечки."
                "\nПідкреслені букви в цих словах позначають різні звуки: у слові сопілка це [с], а в словах заспівала (далі в слові після [с′] пом’якшений губний [п’]) та осьдечки (після [с′] далі м’який знак) – [с′]."
                "\nУ рядку зі словами відповідаючи, забудьте, подякувати підкреслені літери теж позначають різні звуки: у слові відповідаючи це звук [д]; у словах забудьте та подякувати це звук [д′], адже далі відповідно бачимо м’який знак та букву я."
                "\nУ словах квитки та касі вимовляємо звук [к], а в слові вокзалу це звук [ґ], адже глухий звук [к] перед дзвінким вимовляємо як [ґ]."
                "\nУ словах можливості, живокосту, безмежні всі підкреслені літери позначають звук [ж]"
                "\nВідповідь – Г. "
            ),
            "correct_answer": ["Г"]  # not used in the cot branch
        }
        result = format_prompt(row, cot=True, chat_like=True)
        expected_input = (
            'Дайте розгорнуту відповідь на завдання, починаючи з ключового слова "Відповідь:" та використовуючи лише наведені нижче варіанти.'
            '\n\nЗавдання: Однаковий звук позначають букви, виділені в окремих словах речення'
            '\n\nВаріанти відповіді:\nА - Відповідаючи (виділено д - 8-й символ) їм, не забудьте (виділено д - 5-й символ) подякувати (виділено д - 3-й символ).'
            '\nБ - Лікувальні можливості (виділено ж - 3-й символ) живокосту (виділено ж - 1-й символ) безмежні (виділено ж - 6-й символ).'
            '\nВ - Заспівала (виділено с - 3-й символ) сопілочка (виділено с - 1-й символ) осьдечки (виділено с - 2-й символ) за вікном.'
            '\nГ - Ці квитки (виділено к - 1-й символ) можна обміняти в касі (виділено к - 1-й символ) вокзалу (виділено к - 3-й символ). '
        )
        expected_output = (
            'Відповідь:'
            "\nТЕМА: Фонетика. Зміни звуків."
            "\nЦе завдання перевіряє ваші знання про зміни звуків у потоці мовлення. Цьогоріч у завданні запропоновано речення, в окремих словах яких підкреслено певні звуки."
            "\nРозглянемо рядок з такими слова: заспівала, сопілка, осьдечки."
            "\nПідкреслені букви в цих словах позначають різні звуки: у слові сопілка це [с], а в словах заспівала (далі в слові після [с′] пом’якшений губний [п’]) та осьдечки (після [с′] далі м’який знак) – [с′]."
            "\nУ рядку зі словами відповідаючи, забудьте, подякувати підкреслені літери теж позначають різні звуки: у слові відповідаючи це звук [д]; у словах забудьте та подякувати це звук [д′], адже далі відповідно бачимо м’який знак та букву я."
            "\nУ словах квитки та касі вимовляємо звук [к], а в слові вокзалу це звук [ґ], адже глухий звук [к] перед дзвінким вимовляємо як [ґ]."
            "\nУ словах можливості, живокосту, безмежні всі підкреслені літери позначають звук [ж]"
            "\nВідповідь – Г."
        )

        self.assertEqual(result[0], expected_input)
        self.assertEqual(result[1], expected_output)


    def test_format_prompt_no_cot_with_answers(self):
        """
        Test the case when:
          - answer options are provided,
          - chain-of-thought (cot) is disabled,
          - chat_like is False.
        In this branch, the function uses get_prompt(), restores detailed explanation,
        clears only_letters, and formats the options and thoughts using the comment.
        """
        row = {
            "question": "Однаковий звук позначають букви, виділені в окремих словах речення",
            "answers": [
                {"answer": "А", "text": "Відповідаючи (виділено д - 8-й символ) їм, не забудьте (виділено д - 5-й символ) подякувати (виділено д - 3-й символ)."},
                {"answer": "Б", "text": "Лікувальні можливості (виділено ж - 3-й символ) живокосту (виділено ж - 1-й символ) безмежні (виділено ж - 6-й символ)."},
                {"answer": "В", "text": "Заспівала (виділено с - 3-й символ) сопілочка (виділено с - 1-й символ) осьдечки (виділено с - 2-й символ) за вікном."},
                {"answer": "Г", "text": "Ці квитки (виділено к - 1-й символ) можна обміняти в касі (виділено к - 1-й символ) вокзалу (виділено к - 3-й символ). "}
            ],
            "comment": (
                "Коментар"
                "\nТЕМА: Фонетика. Зміни звуків."
                "\nЦе завдання перевіряє ваші знання про зміни звуків у потоці мовлення. Цьогоріч у завданні запропоновано речення, в окремих словах яких підкреслено певні звуки."
                "\nРозглянемо рядок з такими слова: заспівала, сопілка, осьдечки."
                "\nПідкреслені букви в цих словах позначають різні звуки: у слові сопілка це [с], а в словах заспівала (далі в слові після [с′] пом’якшений губний [п’]) та осьдечки (після [с′] далі м’який знак) – [с′]."
                "\nУ рядку зі словами відповідаючи, забудьте, подякувати підкреслені літери теж позначають різні звуки: у слові відповідаючи це звук [д]; у словах забудьте та подякувати це звук [д′], адже далі відповідно бачимо м’який знак та букву я."
                "\nУ словах квитки та касі вимовляємо звук [к], а в слові вокзалу це звук [ґ], адже глухий звук [к] перед дзвінким вимовляємо як [ґ]."
                "\nУ словах можливості, живокосту, безмежні всі підкреслені літери позначають звук [ж]"
                "\nВідповідь – Г. "
            ),
            "correct_answer": ["Г"]  # not used in the cot branch
        }
        result = format_prompt(row, cot=False, chat_like=False)
        expected = (
            'Дайте відповідь на завдання, починаючи з ключового слова "Відповідь:" та використовуючи лише наведені нижче варіанти.'
            ' У якості відповіді наведіть лише літеру, що відповідає правильному варіанту. Якщо правильних відповідей декілька, то перерахуйте їх через ";".'
            '\n\nЗавдання: Однаковий звук позначають букви, виділені в окремих словах речення'
            '\n\nВаріанти відповіді:\nА - Відповідаючи (виділено д - 8-й символ) їм, не забудьте (виділено д - 5-й символ) подякувати (виділено д - 3-й символ).'
            '\nБ - Лікувальні можливості (виділено ж - 3-й символ) живокосту (виділено ж - 1-й символ) безмежні (виділено ж - 6-й символ).'
            '\nВ - Заспівала (виділено с - 3-й символ) сопілочка (виділено с - 1-й символ) осьдечки (виділено с - 2-й символ) за вікном.'
            '\nГ - Ці квитки (виділено к - 1-й символ) можна обміняти в касі (виділено к - 1-й символ) вокзалу (виділено к - 3-й символ). '
            '\n\nВідповідь: Г'
        )
        self.assertEqual(result, expected)


    def test_format_prompt_no_cot_with_answers_chat_like(self):
        """
        Test the case when:
          - answer options are provided,
          - chain-of-thought (cot) is disabled,
          - chat_like is False.
        In this branch, the function uses get_prompt(), restores detailed explanation,
        clears only_letters, and formats the options and thoughts using the comment.
        """
        row = {
            "question": "Однаковий звук позначають букви, виділені в окремих словах речення",
            "answers": [
                {"answer": "А", "text": "Відповідаючи (виділено д - 8-й символ) їм, не забудьте (виділено д - 5-й символ) подякувати (виділено д - 3-й символ)."},
                {"answer": "Б", "text": "Лікувальні можливості (виділено ж - 3-й символ) живокосту (виділено ж - 1-й символ) безмежні (виділено ж - 6-й символ)."},
                {"answer": "В", "text": "Заспівала (виділено с - 3-й символ) сопілочка (виділено с - 1-й символ) осьдечки (виділено с - 2-й символ) за вікном."},
                {"answer": "Г", "text": "Ці квитки (виділено к - 1-й символ) можна обміняти в касі (виділено к - 1-й символ) вокзалу (виділено к - 3-й символ). "}
            ],
            "comment": (
                "Коментар"
                "\nТЕМА: Фонетика. Зміни звуків."
                "\nЦе завдання перевіряє ваші знання про зміни звуків у потоці мовлення. Цьогоріч у завданні запропоновано речення, в окремих словах яких підкреслено певні звуки."
                "\nРозглянемо рядок з такими слова: заспівала, сопілка, осьдечки."
                "\nПідкреслені букви в цих словах позначають різні звуки: у слові сопілка це [с], а в словах заспівала (далі в слові після [с′] пом’якшений губний [п’]) та осьдечки (після [с′] далі м’який знак) – [с′]."
                "\nУ рядку зі словами відповідаючи, забудьте, подякувати підкреслені літери теж позначають різні звуки: у слові відповідаючи це звук [д]; у словах забудьте та подякувати це звук [д′], адже далі відповідно бачимо м’який знак та букву я."
                "\nУ словах квитки та касі вимовляємо звук [к], а в слові вокзалу це звук [ґ], адже глухий звук [к] перед дзвінким вимовляємо як [ґ]."
                "\nУ словах можливості, живокосту, безмежні всі підкреслені літери позначають звук [ж]"
                "\nВідповідь – Г. "
            ),
            "correct_answer": ["Г"]  # not used in the cot branch
        }
        result = format_prompt(row, cot=False, chat_like=True)
        expected_input = (
            'Дайте відповідь на завдання, починаючи з ключового слова "Відповідь:" та використовуючи лише наведені нижче варіанти.'
            ' У якості відповіді наведіть лише літеру, що відповідає правильному варіанту. Якщо правильних відповідей декілька, то перерахуйте їх через ";".'
            '\n\nЗавдання: Однаковий звук позначають букви, виділені в окремих словах речення'
            '\n\nВаріанти відповіді:\nА - Відповідаючи (виділено д - 8-й символ) їм, не забудьте (виділено д - 5-й символ) подякувати (виділено д - 3-й символ).'
            '\nБ - Лікувальні можливості (виділено ж - 3-й символ) живокосту (виділено ж - 1-й символ) безмежні (виділено ж - 6-й символ).'
            '\nВ - Заспівала (виділено с - 3-й символ) сопілочка (виділено с - 1-й символ) осьдечки (виділено с - 2-й символ) за вікном.'
            '\nГ - Ці квитки (виділено к - 1-й символ) можна обміняти в касі (виділено к - 1-й символ) вокзалу (виділено к - 3-й символ). '
        )
        expected_output = 'Відповідь: Г'
        self.assertEqual(result[0], expected_input)
        self.assertEqual(result[1], expected_output)

    def test_format_prompt_cot_with_matching_answers(self):
        """
        Test the case when:
          - answer options are provided,
          - chain-of-thought (cot) is enabled,
          - chat_like is False.
        In this branch, the function uses get_prompt(), restores detailed explanation,
        clears only_letters, and formats the options and thoughts using the comment.
        """
        row = {
            "question": "Однаковий звук позначають букви, виділені в окремих словах речення",
            "answers": [
                {"answer": "1", "text": "гріти чуба"},
                {"answer": "2", "text": "водити за ніс"},
                {"answer": "3", "text": "витикати носа"},
                {"answer": "4", "text": "виводити з рівноваги"},
                {"answer": "А", "text": "не показувати очей"},
                {"answer": "Б", "text": "бити байдики"},
                {"answer": "В", "text": "стояти біля керма"},
                {"answer": "Г", "text": "давати спокій"},
                {"answer": "Д", "text": "розкривати карти"}
            ],
            "comment": (
                "Коментар"
                "\nТЕМА: Фразеологія"
                "\nЗавдання перевіряє ваше вміння пояснювати значення фразеологізмів, добирати до них антоніми."
                "\nЗ’ясуймо значення поданих фразеологізмів:"
                "\nГріти чуба – тяжко працювати, антонім до цього фразеологізму бити байдики – байдикувати, нічого не робити;"
                "\nводити за ніс – обдурювати кого-небудь, приховуючи щось, антонім до цього фразеологізму розкривати карти – переставати приховувати свої (або чиїсь) плани, починати діяти відкрито;"
                "\nвитикати носа – виглянути, визирнути звідки-небудь кудись або з'явитися десь, антонім до цього фразеологізму не показувати очей – не приходити, не з'являтися куди-небудь, до когось;"
                "\nвиводити з рівноваги – позбавляти кого-небудь душевного спокою, дратувати, нервувати, антонім до цього фразеологізму давати спокій – залишати в спокої."
                "\nВідповідь: 1–Б, 2–Д, 3–А, 4–Г."
            ),
            "correct_answer": ["Б", "Д", "А", "Г"]  # not used in the cot branch
        }
        result = format_prompt(row, cot=True, chat_like=False)
        expected = (
            'Дайте розгорнуту відповідь на завдання, починаючи з ключового слова "Відповідь:" та використовуючи лише наведені нижче варіанти.'
            '\n\nЗавдання: Однаковий звук позначають букви, виділені в окремих словах речення'
            '\n\nВаріанти відповіді:\n1 - гріти чуба\n2 - водити за ніс\n3 - витикати носа\n4 - виводити з рівноваги'
            '\nА - не показувати очей\nБ - бити байдики\nВ - стояти біля керма\nГ - давати спокій\nД - розкривати карти'
            '\n\nВідповідь:'
            "\nТЕМА: Фразеологія"
            "\nЗавдання перевіряє ваше вміння пояснювати значення фразеологізмів, добирати до них антоніми."
            "\nЗ’ясуймо значення поданих фразеологізмів:"
            "\nГріти чуба – тяжко працювати, антонім до цього фразеологізму бити байдики – байдикувати, нічого не робити;"
            "\nводити за ніс – обдурювати кого-небудь, приховуючи щось, антонім до цього фразеологізму розкривати карти – переставати приховувати свої (або чиїсь) плани, починати діяти відкрито;"
            "\nвитикати носа – виглянути, визирнути звідки-небудь кудись або з'явитися десь, антонім до цього фразеологізму не показувати очей – не приходити, не з'являтися куди-небудь, до когось;"
            "\nвиводити з рівноваги – позбавляти кого-небудь душевного спокою, дратувати, нервувати, антонім до цього фразеологізму давати спокій – залишати в спокої."
            "\nВідповідь: 1–Б, 2–Д, 3–А, 4–Г."
        )
        self.assertEqual(result, expected)

    def test_format_prompt_cot_with_matching_answers_chat_like(self):
        """
        Test the case when:
          - answer options are provided,
          - chain-of-thought (cot) is enabled,
          - chat_like is False.
        In this branch, the function uses get_prompt(), restores detailed explanation,
        clears only_letters, and formats the options and thoughts using the comment.
        """
        row = {
            "question": "Однаковий звук позначають букви, виділені в окремих словах речення",
            "answers": [
                {"answer": "1", "text": "гріти чуба"},
                {"answer": "2", "text": "водити за ніс"},
                {"answer": "3", "text": "витикати носа"},
                {"answer": "4", "text": "виводити з рівноваги"},
                {"answer": "А", "text": "не показувати очей"},
                {"answer": "Б", "text": "бити байдики"},
                {"answer": "В", "text": "стояти біля керма"},
                {"answer": "Г", "text": "давати спокій"},
                {"answer": "Д", "text": "розкривати карти"}
            ],
            "comment": (
                "Коментар"
                "\nТЕМА: Фразеологія"
                "\nЗавдання перевіряє ваше вміння пояснювати значення фразеологізмів, добирати до них антоніми."
                "\nЗ’ясуймо значення поданих фразеологізмів:"
                "\nГріти чуба – тяжко працювати, антонім до цього фразеологізму бити байдики – байдикувати, нічого не робити;"
                "\nводити за ніс – обдурювати кого-небудь, приховуючи щось, антонім до цього фразеологізму розкривати карти – переставати приховувати свої (або чиїсь) плани, починати діяти відкрито;"
                "\nвитикати носа – виглянути, визирнути звідки-небудь кудись або з'явитися десь, антонім до цього фразеологізму не показувати очей – не приходити, не з'являтися куди-небудь, до когось;"
                "\nвиводити з рівноваги – позбавляти кого-небудь душевного спокою, дратувати, нервувати, антонім до цього фразеологізму давати спокій – залишати в спокої."
                "\nВідповідь: 1–Б, 2–Д, 3–А, 4–Г."
            ),
            "correct_answer": ["Б", "Д", "А", "Г"]  # not used in the cot branch
        }
        result = format_prompt(row, cot=True, chat_like=True)
        expected_input = (
            'Дайте розгорнуту відповідь на завдання, починаючи з ключового слова "Відповідь:" та використовуючи лише наведені нижче варіанти.'
            '\n\nЗавдання: Однаковий звук позначають букви, виділені в окремих словах речення'
            '\n\nВаріанти відповіді:\n1 - гріти чуба\n2 - водити за ніс\n3 - витикати носа\n4 - виводити з рівноваги'
            '\nА - не показувати очей\nБ - бити байдики\nВ - стояти біля керма\nГ - давати спокій\nД - розкривати карти'
        )
        expected_output = (
            'Відповідь:'
            "\nТЕМА: Фразеологія"
            "\nЗавдання перевіряє ваше вміння пояснювати значення фразеологізмів, добирати до них антоніми."
            "\nЗ’ясуймо значення поданих фразеологізмів:"
            "\nГріти чуба – тяжко працювати, антонім до цього фразеологізму бити байдики – байдикувати, нічого не робити;"
            "\nводити за ніс – обдурювати кого-небудь, приховуючи щось, антонім до цього фразеологізму розкривати карти – переставати приховувати свої (або чиїсь) плани, починати діяти відкрито;"
            "\nвитикати носа – виглянути, визирнути звідки-небудь кудись або з'явитися десь, антонім до цього фразеологізму не показувати очей – не приходити, не з'являтися куди-небудь, до когось;"
            "\nвиводити з рівноваги – позбавляти кого-небудь душевного спокою, дратувати, нервувати, антонім до цього фразеологізму давати спокій – залишати в спокої."
            "\nВідповідь: 1–Б, 2–Д, 3–А, 4–Г."
        )
        self.assertEqual(result[0], expected_input)
        self.assertEqual(result[1], expected_output)

    def test_format_prompt_no_cot_with_matching_answers(self):
        """
        Test the case when:
          - answer options are provided,
          - chain-of-thought (cot) is enabled,
          - chat_like is False.
        In this branch, the function uses get_prompt(), restores detailed explanation,
        clears only_letters, and formats the options and thoughts using the comment.
        """
        row = {
            "question": "Однаковий звук позначають букви, виділені в окремих словах речення",
            "answers": [
                {"answer": "1", "text": "гріти чуба"},
                {"answer": "2", "text": "водити за ніс"},
                {"answer": "3", "text": "витикати носа"},
                {"answer": "4", "text": "виводити з рівноваги"},
                {"answer": "А", "text": "не показувати очей"},
                {"answer": "Б", "text": "бити байдики"},
                {"answer": "В", "text": "стояти біля керма"},
                {"answer": "Г", "text": "давати спокій"},
                {"answer": "Д", "text": "розкривати карти"}
            ],
            "comment": (
                "Коментар"
                "\nТЕМА: Фразеологія"
                "\nЗавдання перевіряє ваше вміння пояснювати значення фразеологізмів, добирати до них антоніми."
                "\nЗ’ясуймо значення поданих фразеологізмів:"
                "\nГріти чуба – тяжко працювати, антонім до цього фразеологізму бити байдики – байдикувати, нічого не робити;"
                "\nводити за ніс – обдурювати кого-небудь, приховуючи щось, антонім до цього фразеологізму розкривати карти – переставати приховувати свої (або чиїсь) плани, починати діяти відкрито;"
                "\nвитикати носа – виглянути, визирнути звідки-небудь кудись або з'явитися десь, антонім до цього фразеологізму не показувати очей – не приходити, не з'являтися куди-небудь, до когось;"
                "\nвиводити з рівноваги – позбавляти кого-небудь душевного спокою, дратувати, нервувати, антонім до цього фразеологізму давати спокій – залишати в спокої."
                "\nВідповідь: 1–Б, 2–Д, 3–А, 4–Г."
            ),
            "correct_answer": ["Б", "Д", "А", "Г"]  # not used in the cot branch
        }
        result = format_prompt(row, cot=False, chat_like=False)
        expected = (
            'Дайте відповідь на завдання, починаючи з ключового слова "Відповідь:" та використовуючи лише наведені нижче варіанти.'
            ' У якості відповіді наведіть лише літеру, що відповідає правильному варіанту. Якщо правильних відповідей декілька, то перерахуйте їх через ";".'
            '\n\nЗавдання: Однаковий звук позначають букви, виділені в окремих словах речення'
            '\n\nВаріанти відповіді:\n1 - гріти чуба\n2 - водити за ніс\n3 - витикати носа\n4 - виводити з рівноваги'
            '\nА - не показувати очей\nБ - бити байдики\nВ - стояти біля керма\nГ - давати спокій\nД - розкривати карти'
            '\n\nВідповідь: Б;Д;А;Г'
        )
        self.assertEqual(result, expected)

    def test_format_prompt_no_cot_with_matching_answers_chat_like(self):
        """
        Test the case when:
          - answer options are provided,
          - chain-of-thought (cot) is enabled,
          - chat_like is False.
        In this branch, the function uses get_prompt(), restores detailed explanation,
        clears only_letters, and formats the options and thoughts using the comment.
        """
        row = {
            "question": "Однаковий звук позначають букви, виділені в окремих словах речення",
            "answers": [
                {"answer": "1", "text": "гріти чуба"},
                {"answer": "2", "text": "водити за ніс"},
                {"answer": "3", "text": "витикати носа"},
                {"answer": "4", "text": "виводити з рівноваги"},
                {"answer": "А", "text": "не показувати очей"},
                {"answer": "Б", "text": "бити байдики"},
                {"answer": "В", "text": "стояти біля керма"},
                {"answer": "Г", "text": "давати спокій"},
                {"answer": "Д", "text": "розкривати карти"}
            ],
            "comment": (
                "Коментар"
                "\nТЕМА: Фразеологія"
                "\nЗавдання перевіряє ваше вміння пояснювати значення фразеологізмів, добирати до них антоніми."
                "\nЗ’ясуймо значення поданих фразеологізмів:"
                "\nГріти чуба – тяжко працювати, антонім до цього фразеологізму бити байдики – байдикувати, нічого не робити;"
                "\nводити за ніс – обдурювати кого-небудь, приховуючи щось, антонім до цього фразеологізму розкривати карти – переставати приховувати свої (або чиїсь) плани, починати діяти відкрито;"
                "\nвитикати носа – виглянути, визирнути звідки-небудь кудись або з'явитися десь, антонім до цього фразеологізму не показувати очей – не приходити, не з'являтися куди-небудь, до когось;"
                "\nвиводити з рівноваги – позбавляти кого-небудь душевного спокою, дратувати, нервувати, антонім до цього фразеологізму давати спокій – залишати в спокої."
                "\nВідповідь: 1–Б, 2–Д, 3–А, 4–Г."
            ),
            "correct_answer": ["Б", "Д", "А", "Г"]  # not used in the cot branch
        }
        result = format_prompt(row, cot=False, chat_like=True)
        expected_input = (
            'Дайте відповідь на завдання, починаючи з ключового слова "Відповідь:" та використовуючи лише наведені нижче варіанти.'
            ' У якості відповіді наведіть лише літеру, що відповідає правильному варіанту. Якщо правильних відповідей декілька, то перерахуйте їх через ";".'
            '\n\nЗавдання: Однаковий звук позначають букви, виділені в окремих словах речення'
            '\n\nВаріанти відповіді:\n1 - гріти чуба\n2 - водити за ніс\n3 - витикати носа\n4 - виводити з рівноваги'
            '\nА - не показувати очей\nБ - бити байдики\nВ - стояти біля керма\nГ - давати спокій\nД - розкривати карти'
        )
        expected_output = 'Відповідь: Б;Д;А;Г'
        self.assertEqual(result[0], expected_input)
        self.assertEqual(result[1], expected_output)

    def test_format_prompt_cot_no_topic_with_answers(self):
        """
        Test the case when:
          - answer options are provided,
          - chain-of-thought (cot) is enabled,
          - chat_like is False.
        In this branch, the function uses get_prompt(), restores detailed explanation,
        clears only_letters, and formats the options and thoughts using the comment.
        """
        row = {
            "question": "Однаковий звук позначають букви, виділені в окремих словах речення",
            "answers": [
                {"answer": "А", "text": "Відповідаючи (виділено д - 8-й символ) їм, не забудьте (виділено д - 5-й символ) подякувати (виділено д - 3-й символ)."},
                {"answer": "Б", "text": "Лікувальні можливості (виділено ж - 3-й символ) живокосту (виділено ж - 1-й символ) безмежні (виділено ж - 6-й символ)."},
                {"answer": "В", "text": "Заспівала (виділено с - 3-й символ) сопілочка (виділено с - 1-й символ) осьдечки (виділено с - 2-й символ) за вікном."},
                {"answer": "Г", "text": "Ці квитки (виділено к - 1-й символ) можна обміняти в касі (виділено к - 1-й символ) вокзалу (виділено к - 3-й символ). "}
            ],
            "comment": (
                "Коментар"
                "\nТЕМА: Фонетика. Зміни звуків."
                "\nЦе завдання перевіряє ваші знання про зміни звуків у потоці мовлення. Цьогоріч у завданні запропоновано речення, в окремих словах яких підкреслено певні звуки."
                "\nРозглянемо рядок з такими слова: заспівала, сопілка, осьдечки."
                "\nПідкреслені букви в цих словах позначають різні звуки: у слові сопілка це [с], а в словах заспівала (далі в слові після [с′] пом’якшений губний [п’]) та осьдечки (після [с′] далі м’який знак) – [с′]."
                "\nУ рядку зі словами відповідаючи, забудьте, подякувати підкреслені літери теж позначають різні звуки: у слові відповідаючи це звук [д]; у словах забудьте та подякувати це звук [д′], адже далі відповідно бачимо м’який знак та букву я."
                "\nУ словах квитки та касі вимовляємо звук [к], а в слові вокзалу це звук [ґ], адже глухий звук [к] перед дзвінким вимовляємо як [ґ]."
                "\nУ словах можливості, живокосту, безмежні всі підкреслені літери позначають звук [ж]"
                "\nВідповідь – Г. "
            ),
            "correct_answer": ["Г"]  # not used in the cot branch
        }
        result = format_prompt(row, cot=True, chat_like=False, with_topic=False)
        expected = (
            'Дайте розгорнуту відповідь на завдання, починаючи з ключового слова "Відповідь:" та використовуючи лише наведені нижче варіанти.'
            '\n\nЗавдання: Однаковий звук позначають букви, виділені в окремих словах речення'
            '\n\nВаріанти відповіді:\nА - Відповідаючи (виділено д - 8-й символ) їм, не забудьте (виділено д - 5-й символ) подякувати (виділено д - 3-й символ).'
            '\nБ - Лікувальні можливості (виділено ж - 3-й символ) живокосту (виділено ж - 1-й символ) безмежні (виділено ж - 6-й символ).'
            '\nВ - Заспівала (виділено с - 3-й символ) сопілочка (виділено с - 1-й символ) осьдечки (виділено с - 2-й символ) за вікном.'
            '\nГ - Ці квитки (виділено к - 1-й символ) можна обміняти в касі (виділено к - 1-й символ) вокзалу (виділено к - 3-й символ). '
            '\n\nВідповідь:'
            "\nЦе завдання перевіряє ваші знання про зміни звуків у потоці мовлення. Цьогоріч у завданні запропоновано речення, в окремих словах яких підкреслено певні звуки."
            "\nРозглянемо рядок з такими слова: заспівала, сопілка, осьдечки."
            "\nПідкреслені букви в цих словах позначають різні звуки: у слові сопілка це [с], а в словах заспівала (далі в слові після [с′] пом’якшений губний [п’]) та осьдечки (після [с′] далі м’який знак) – [с′]."
            "\nУ рядку зі словами відповідаючи, забудьте, подякувати підкреслені літери теж позначають різні звуки: у слові відповідаючи це звук [д]; у словах забудьте та подякувати це звук [д′], адже далі відповідно бачимо м’який знак та букву я."
            "\nУ словах квитки та касі вимовляємо звук [к], а в слові вокзалу це звук [ґ], адже глухий звук [к] перед дзвінким вимовляємо як [ґ]."
            "\nУ словах можливості, живокосту, безмежні всі підкреслені літери позначають звук [ж]"
            "\nВідповідь – Г."
        )
        self.assertEqual(result, expected)


    def test_format_prompt_cot_no_topic_with_answers_chat_like(self):
        """
        Test the case when:
          - answer options are provided,
          - chain-of-thought (cot) is enabled,
          - chat_like is True.
        In this branch, the function uses get_prompt(), restores detailed explanation,
        clears only_letters, and formats the options and thoughts using the comment.
        """
        row = {
            "question": "Однаковий звук позначають букви, виділені в окремих словах речення",
            "answers": [
                {"answer": "А", "text": "Відповідаючи (виділено д - 8-й символ) їм, не забудьте (виділено д - 5-й символ) подякувати (виділено д - 3-й символ)."},
                {"answer": "Б", "text": "Лікувальні можливості (виділено ж - 3-й символ) живокосту (виділено ж - 1-й символ) безмежні (виділено ж - 6-й символ)."},
                {"answer": "В", "text": "Заспівала (виділено с - 3-й символ) сопілочка (виділено с - 1-й символ) осьдечки (виділено с - 2-й символ) за вікном."},
                {"answer": "Г", "text": "Ці квитки (виділено к - 1-й символ) можна обміняти в касі (виділено к - 1-й символ) вокзалу (виділено к - 3-й символ). "}
            ],
            "comment": (
                "Коментар"
                "\nТЕМА: Фонетика. Зміни звуків."
                "\nЦе завдання перевіряє ваші знання про зміни звуків у потоці мовлення. Цьогоріч у завданні запропоновано речення, в окремих словах яких підкреслено певні звуки."
                "\nРозглянемо рядок з такими слова: заспівала, сопілка, осьдечки."
                "\nПідкреслені букви в цих словах позначають різні звуки: у слові сопілка це [с], а в словах заспівала (далі в слові після [с′] пом’якшений губний [п’]) та осьдечки (після [с′] далі м’який знак) – [с′]."
                "\nУ рядку зі словами відповідаючи, забудьте, подякувати підкреслені літери теж позначають різні звуки: у слові відповідаючи це звук [д]; у словах забудьте та подякувати це звук [д′], адже далі відповідно бачимо м’який знак та букву я."
                "\nУ словах квитки та касі вимовляємо звук [к], а в слові вокзалу це звук [ґ], адже глухий звук [к] перед дзвінким вимовляємо як [ґ]."
                "\nУ словах можливості, живокосту, безмежні всі підкреслені літери позначають звук [ж]"
                "\nВідповідь – Г. "
            ),
            "correct_answer": ["Г"]  # not used in the cot branch
        }
        result = format_prompt(row, cot=True, chat_like=True, with_topic=False)
        expected_input = (
            'Дайте розгорнуту відповідь на завдання, починаючи з ключового слова "Відповідь:" та використовуючи лише наведені нижче варіанти.'
            '\n\nЗавдання: Однаковий звук позначають букви, виділені в окремих словах речення'
            '\n\nВаріанти відповіді:\nА - Відповідаючи (виділено д - 8-й символ) їм, не забудьте (виділено д - 5-й символ) подякувати (виділено д - 3-й символ).'
            '\nБ - Лікувальні можливості (виділено ж - 3-й символ) живокосту (виділено ж - 1-й символ) безмежні (виділено ж - 6-й символ).'
            '\nВ - Заспівала (виділено с - 3-й символ) сопілочка (виділено с - 1-й символ) осьдечки (виділено с - 2-й символ) за вікном.'
            '\nГ - Ці квитки (виділено к - 1-й символ) можна обміняти в касі (виділено к - 1-й символ) вокзалу (виділено к - 3-й символ). '
        )
        expected_output = (
            'Відповідь:'
            "\nЦе завдання перевіряє ваші знання про зміни звуків у потоці мовлення. Цьогоріч у завданні запропоновано речення, в окремих словах яких підкреслено певні звуки."
            "\nРозглянемо рядок з такими слова: заспівала, сопілка, осьдечки."
            "\nПідкреслені букви в цих словах позначають різні звуки: у слові сопілка це [с], а в словах заспівала (далі в слові після [с′] пом’якшений губний [п’]) та осьдечки (після [с′] далі м’який знак) – [с′]."
            "\nУ рядку зі словами відповідаючи, забудьте, подякувати підкреслені літери теж позначають різні звуки: у слові відповідаючи це звук [д]; у словах забудьте та подякувати це звук [д′], адже далі відповідно бачимо м’який знак та букву я."
            "\nУ словах квитки та касі вимовляємо звук [к], а в слові вокзалу це звук [ґ], адже глухий звук [к] перед дзвінким вимовляємо як [ґ]."
            "\nУ словах можливості, живокосту, безмежні всі підкреслені літери позначають звук [ж]"
            "\nВідповідь – Г."
        )

        self.assertEqual(result[0], expected_input)
        self.assertEqual(result[1], expected_output)


    def test_format_prompt_no_cot_no_topic_with_answers(self):
        """
        Test the case when:
          - answer options are provided,
          - chain-of-thought (cot) is disabled,
          - chat_like is False.
        In this branch, the function uses get_prompt(), restores detailed explanation,
        clears only_letters, and formats the options and thoughts using the comment.
        """
        row = {
            "question": "Однаковий звук позначають букви, виділені в окремих словах речення",
            "answers": [
                {"answer": "А", "text": "Відповідаючи (виділено д - 8-й символ) їм, не забудьте (виділено д - 5-й символ) подякувати (виділено д - 3-й символ)."},
                {"answer": "Б", "text": "Лікувальні можливості (виділено ж - 3-й символ) живокосту (виділено ж - 1-й символ) безмежні (виділено ж - 6-й символ)."},
                {"answer": "В", "text": "Заспівала (виділено с - 3-й символ) сопілочка (виділено с - 1-й символ) осьдечки (виділено с - 2-й символ) за вікном."},
                {"answer": "Г", "text": "Ці квитки (виділено к - 1-й символ) можна обміняти в касі (виділено к - 1-й символ) вокзалу (виділено к - 3-й символ). "}
            ],
            "comment": (
                "Коментар"
                "\nТЕМА: Фонетика. Зміни звуків."
                "\nЦе завдання перевіряє ваші знання про зміни звуків у потоці мовлення. Цьогоріч у завданні запропоновано речення, в окремих словах яких підкреслено певні звуки."
                "\nРозглянемо рядок з такими слова: заспівала, сопілка, осьдечки."
                "\nПідкреслені букви в цих словах позначають різні звуки: у слові сопілка це [с], а в словах заспівала (далі в слові після [с′] пом’якшений губний [п’]) та осьдечки (після [с′] далі м’який знак) – [с′]."
                "\nУ рядку зі словами відповідаючи, забудьте, подякувати підкреслені літери теж позначають різні звуки: у слові відповідаючи це звук [д]; у словах забудьте та подякувати це звук [д′], адже далі відповідно бачимо м’який знак та букву я."
                "\nУ словах квитки та касі вимовляємо звук [к], а в слові вокзалу це звук [ґ], адже глухий звук [к] перед дзвінким вимовляємо як [ґ]."
                "\nУ словах можливості, живокосту, безмежні всі підкреслені літери позначають звук [ж]"
                "\nВідповідь – Г. "
            ),
            "correct_answer": ["Г"]  # not used in the cot branch
        }
        result = format_prompt(row, cot=False, chat_like=False, with_topic=False)
        expected = (
            'Дайте відповідь на завдання, починаючи з ключового слова "Відповідь:" та використовуючи лише наведені нижче варіанти.'
            ' У якості відповіді наведіть лише літеру, що відповідає правильному варіанту. Якщо правильних відповідей декілька, то перерахуйте їх через ";".'
            '\n\nЗавдання: Однаковий звук позначають букви, виділені в окремих словах речення'
            '\n\nВаріанти відповіді:\nА - Відповідаючи (виділено д - 8-й символ) їм, не забудьте (виділено д - 5-й символ) подякувати (виділено д - 3-й символ).'
            '\nБ - Лікувальні можливості (виділено ж - 3-й символ) живокосту (виділено ж - 1-й символ) безмежні (виділено ж - 6-й символ).'
            '\nВ - Заспівала (виділено с - 3-й символ) сопілочка (виділено с - 1-й символ) осьдечки (виділено с - 2-й символ) за вікном.'
            '\nГ - Ці квитки (виділено к - 1-й символ) можна обміняти в касі (виділено к - 1-й символ) вокзалу (виділено к - 3-й символ). '
            '\n\nВідповідь: Г'
        )
        self.assertEqual(result, expected)


    def test_format_prompt_no_cot_no_topic_with_answers_chat_like(self):
        """
        Test the case when:
          - answer options are provided,
          - chain-of-thought (cot) is disabled,
          - chat_like is False.
        In this branch, the function uses get_prompt(), restores detailed explanation,
        clears only_letters, and formats the options and thoughts using the comment.
        """
        row = {
            "question": "Однаковий звук позначають букви, виділені в окремих словах речення",
            "answers": [
                {"answer": "А", "text": "Відповідаючи (виділено д - 8-й символ) їм, не забудьте (виділено д - 5-й символ) подякувати (виділено д - 3-й символ)."},
                {"answer": "Б", "text": "Лікувальні можливості (виділено ж - 3-й символ) живокосту (виділено ж - 1-й символ) безмежні (виділено ж - 6-й символ)."},
                {"answer": "В", "text": "Заспівала (виділено с - 3-й символ) сопілочка (виділено с - 1-й символ) осьдечки (виділено с - 2-й символ) за вікном."},
                {"answer": "Г", "text": "Ці квитки (виділено к - 1-й символ) можна обміняти в касі (виділено к - 1-й символ) вокзалу (виділено к - 3-й символ). "}
            ],
            "comment": (
                "Коментар"
                "\nТЕМА: Фонетика. Зміни звуків."
                "\nЦе завдання перевіряє ваші знання про зміни звуків у потоці мовлення. Цьогоріч у завданні запропоновано речення, в окремих словах яких підкреслено певні звуки."
                "\nРозглянемо рядок з такими слова: заспівала, сопілка, осьдечки."
                "\nПідкреслені букви в цих словах позначають різні звуки: у слові сопілка це [с], а в словах заспівала (далі в слові після [с′] пом’якшений губний [п’]) та осьдечки (після [с′] далі м’який знак) – [с′]."
                "\nУ рядку зі словами відповідаючи, забудьте, подякувати підкреслені літери теж позначають різні звуки: у слові відповідаючи це звук [д]; у словах забудьте та подякувати це звук [д′], адже далі відповідно бачимо м’який знак та букву я."
                "\nУ словах квитки та касі вимовляємо звук [к], а в слові вокзалу це звук [ґ], адже глухий звук [к] перед дзвінким вимовляємо як [ґ]."
                "\nУ словах можливості, живокосту, безмежні всі підкреслені літери позначають звук [ж]"
                "\nВідповідь – Г. "
            ),
            "correct_answer": ["Г"]  # not used in the cot branch
        }
        result = format_prompt(row, cot=False, chat_like=True, with_topic=False)
        expected_input = (
            'Дайте відповідь на завдання, починаючи з ключового слова "Відповідь:" та використовуючи лише наведені нижче варіанти.'
            ' У якості відповіді наведіть лише літеру, що відповідає правильному варіанту. Якщо правильних відповідей декілька, то перерахуйте їх через ";".'
            '\n\nЗавдання: Однаковий звук позначають букви, виділені в окремих словах речення'
            '\n\nВаріанти відповіді:\nА - Відповідаючи (виділено д - 8-й символ) їм, не забудьте (виділено д - 5-й символ) подякувати (виділено д - 3-й символ).'
            '\nБ - Лікувальні можливості (виділено ж - 3-й символ) живокосту (виділено ж - 1-й символ) безмежні (виділено ж - 6-й символ).'
            '\nВ - Заспівала (виділено с - 3-й символ) сопілочка (виділено с - 1-й символ) осьдечки (виділено с - 2-й символ) за вікном.'
            '\nГ - Ці квитки (виділено к - 1-й символ) можна обміняти в касі (виділено к - 1-й символ) вокзалу (виділено к - 3-й символ). '
        )
        expected_output = 'Відповідь: Г'
        self.assertEqual(result[0], expected_input)
        self.assertEqual(result[1], expected_output)


    def test_format_prompt_cot_with_no_answers(self):
        """
        Test the case when:
          - no answer options are provided (empty list),
          - chain-of-thought is enabled,
          - chat_like is False.
        In this branch, the absence of answer options forces detailed to be set,
        and using_options and only_letters to be empty.
        """
        row = {
            "question": "Що таке 2+2?",
            "answers": [],
            "comment": "Коментар\nПояснення.",
            "correct_answer": ["B"]  # not used in the cot branch
        }
        result = format_prompt(row, cot=True, chat_like=False)
        expected = (
            'Дайте розгорнуту відповідь на завдання, починаючи з ключового слова "Відповідь:".'
            '\n\nЗавдання: Що таке 2+2?'
            '\n\n'
            '\n\nВідповідь:\nПояснення.'
        )
        self.assertEqual(result, expected)

    def test_format_prompt_no_cot_with_no_answers(self):
        """
        Test the case when:
          - no answer options are provided (empty list),
          - chain-of-thought is enabled,
          - chat_like is False.
        In this branch, the absence of answer options forces detailed to be set,
        and using_options and only_letters to be empty.
        """
        row = {
            "question": "Що таке 2+2?",
            "answers": [],
            "comment": "Коментар\nПояснення.",
            "correct_answer": []  # not used in the cot branch
        }
        result = format_prompt(row, cot=False, chat_like=False)
        expected = (
            'Дайте розгорнуту відповідь на завдання, починаючи з ключового слова "Відповідь:".'
            '\n\nЗавдання: Що таке 2+2?'
            '\n\n'
            '\n\nВідповідь: '
        )
        self.assertEqual(result, expected)

    def test_format_prompt_without_cot_single_correct(self):
        """
        Test the case when:
          - answer options are provided,
          - chain-of-thought is disabled (cot=False),
          - there is a single correct answer.
        In this branch, the function uses the correct_answer field to build the thoughts,
        and the initial values for detailed, using_options, and only_letters remain.
        """
        row = {
            "question": "Який колір?",
            "answers": [
                {"answer": "A", "text": "Червоний"},
                {"answer": "B", "text": "Синій"}
            ],
            "comment": "Коментар\nНе використовується.",
            "correct_answer": ["B"]
        }
        result = format_prompt(row, cot=False, chat_like=False)
        expected = (
            'Дайте відповідь на завдання, починаючи з ключового слова "Відповідь:" та використовуючи лише наведені нижче варіанти.'
            ' У якості відповіді наведіть лише літеру, що відповідає правильному варіанту. Якщо правильних відповідей декілька, то перерахуйте їх через ";".'
            '\n\nЗавдання: Який колір?'
            '\n\nВаріанти відповіді:\nA - Червоний\nB - Синій'
            '\n\nВідповідь: B'
        )
        self.assertEqual(result, expected)

    def test_format_prompt_without_cot_multiple_correct(self):
        """
        Test the case when:
          - answer options are provided,
          - chain-of-thought is disabled (cot=False),
          - there are multiple correct answers.
        The function should join multiple correct answers with ";".
        """
        row = {
            "question": "Виберіть літери",
            "answers": [
                {"answer": "A", "text": "Option A"},
                {"answer": "B", "text": "Option B"},
                {"answer": "C", "text": "Option C"}
            ],
            "comment": "Коментар\nНе використовується.",
            "correct_answer": ["A", "C"]
        }
        result = format_prompt(row, cot=False, chat_like=False)
        expected = (
            'Дайте відповідь на завдання, починаючи з ключового слова "Відповідь:" та використовуючи лише наведені нижче варіанти.'
            ' У якості відповіді наведіть лише літеру, що відповідає правильному варіанту. Якщо правильних відповідей декілька, то перерахуйте їх через ";".'
            '\n\nЗавдання: Виберіть літери'
            '\n\nВаріанти відповіді:\nA - Option A\nB - Option B\nC - Option C'
            '\n\nВідповідь: A;C'
        )
        self.assertEqual(result, expected)


# --- Unit Tests ---
class TestApplyTemplate(unittest.TestCase):
    
    def test_basic_functionality(self):
        """
        Verify that for a simple dataset without a replace_map and with debug off,
        the function returns the expected templated texts.
        """
        dataset = [
            ("Question 1", "Answer 1"),
            ("Question 2", "Answer 2")
        ]
        tokenizer = AutoTokenizer.from_pretrained("meta-llama/Llama-3.1-8B-Instruct")
        result = apply_template(tokenizer, dataset, debug=False)
        expected_texts = [
            (
                "<|begin_of_text|><|start_header_id|>system<|end_header_id|>\n\nCutting Knowledge Date: December 2023\nToday Date: 26 Jul 2024\n\n<|eot_id|>"
                "<|start_header_id|>user<|end_header_id|>\n\nQuestion 1<|eot_id|><|start_header_id|>assistant<|end_header_id|>\n\nAnswer 1<|eot_id|>"
            ),
            (
                "<|begin_of_text|><|start_header_id|>system<|end_header_id|>\n\nCutting Knowledge Date: December 2023\nToday Date: 26 Jul 2024\n\n<|eot_id|>"
                "<|start_header_id|>user<|end_header_id|>\n\nQuestion 2<|eot_id|><|start_header_id|>assistant<|end_header_id|>\n\nAnswer 2<|eot_id|>"
            ),
        ]
        self.assertEqual(result, {"text": expected_texts})

    def test_replace_map(self):
        """
        Verify that when a replace_map is provided, its replacements are applied.
        In this test, we replace the substring "foo" with "bar" in the templated text.
        """
        dataset = [
            ("Question 1", "Answer 1"),
        ]
        tokenizer = AutoTokenizer.from_pretrained("meta-llama/Llama-3.1-8B-Instruct")
        replace_map = {"<|begin_of_text|>": ""}
        result = apply_template(tokenizer, dataset, debug=False, replace_map=replace_map)
        expected_texts = [
            (
                "<|start_header_id|>system<|end_header_id|>\n\nCutting Knowledge Date: December 2023\nToday Date: 26 Jul 2024\n\n<|eot_id|>"
                "<|start_header_id|>user<|end_header_id|>\n\nQuestion 1<|eot_id|><|start_header_id|>assistant<|end_header_id|>\n\nAnswer 1<|eot_id|>"
            ),
        ]
        self.assertEqual(result, {"text": expected_texts})

    @patch("logging.info")
    def test_llama_warning_once(self, mock_print):
        """
        If the tokenizer's name contains "llama" and the templated text starts with
        "<|begin_of_text|>", a warning message should be printed only once, even if multiple rows trigger it.
        """
        dataset = [
            ("Question 1", "Answer 1"),
            ("Question 2", "Answer 2")
        ]
        # Set template_prefix so that text starts with "<|begin_of_text|>"
        tokenizer = AutoTokenizer.from_pretrained("meta-llama/Llama-3.1-8B-Instruct")
        apply_template(tokenizer, dataset, debug=False)
        
        # The function prints multiple lines: the initial templating info and (if triggered) the warning.
        # We'll count how many times the warning message appears.
        warning_calls = [call_args for call_args in mock_print.call_args_list
                         if "Warning: templated text starts with <|begin_of_text|>" in call_args[0][0]]
        self.assertEqual(len(warning_calls), 1, "Warning should be printed exactly once.")

    @patch("logging.info")
    def test_debug_printing(self, mock_print):
        """
        When debug is True, the function should print the templated texts for the first 5 rows.
        We verify that debug prints (identified by the debug separator) occur only for the first 5 rows.
        """
        dataset = [
            ("Question 1", "Answer 1"),
            ("Question 2", "Answer 2"),
            ("Question 3", "Answer 3"),
            ("Question 4", "Answer 4"),
            ("Question 5", "Answer 5"),
            ("Question 6", "Answer 6")  # Extra row beyond the first 5.
        ]
        tokenizer = AutoTokenizer.from_pretrained("meta-llama/Llama-3.1-8B-Instruct")
        apply_template(tokenizer, dataset, debug=True)
        
        # Look for the separator printed in the debug block.
        #print("Debug prints: ", mock_print.call_args_list)
        debug_prints = [args for args, _ in mock_print.call_args_list if "\n---------------------------------------------------\n" in args[-1]]
        self.assertEqual(len(debug_prints), 5, f"Debug prints should occur for only the first 5 rows. {debug_prints}")


if __name__ == '__main__':
    unittest.main()
